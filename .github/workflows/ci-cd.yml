# =============================================================================
# CI/CD WORKFLOW - MAIN & HOTFIX BRANCHES
# =============================================================================
# Triggered on: Push to main or hotfix/* branches
# Pipeline: Build â†’ Deploy to QA
# =============================================================================

name: CI/CD

on:
  push:
    branches:
      - main
      - 'hotfix/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'

concurrency:
  group: cicd-${{ github.ref_name }}
  cancel-in-progress: false  # Don't cancel in-progress deployments

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  # ---------------------------------------------------------------------------
  # Generate version based on run number
  # ---------------------------------------------------------------------------
  version:
    name: Generate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short-sha: ${{ steps.version.outputs.short-sha }}
      is-hotfix: ${{ steps.version.outputs.is-hotfix }}

    steps:
      - name: Generate version
        id: version
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"

          # Check if this is a hotfix branch
          if [[ "${{ github.ref_name }}" == hotfix/* ]]; then
            # Hotfix version: 1.0.{run_number}-hotfix
            VERSION="1.0.${{ github.run_number }}-hotfix"
            IS_HOTFIX="true"
            echo "Hotfix build from branch: ${{ github.ref_name }}"
          else
            # Main version: 1.0.{run_number}
            VERSION="1.0.${{ github.run_number }}"
            IS_HOTFIX="false"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "is-hotfix=${IS_HOTFIX}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

  # ---------------------------------------------------------------------------
  # Build (reusable workflow)
  # ---------------------------------------------------------------------------
  build:
    name: Build
    needs: version
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ needs.version.outputs.version }}
      is-release: false

  # ---------------------------------------------------------------------------
  # Deploy to QA (automatic after successful build)
  # ---------------------------------------------------------------------------
  deploy-qa:
    name: Deploy to QA
    needs: [version, build]
    runs-on: ubuntu-latest
    environment:
      name: qa
      url: https://qa.example.com

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./deploy

      - name: Deploy to QA
        run: |
          echo "Deploying ${{ needs.build.outputs.artifact-name }} to QA..."
          echo "Version: ${{ needs.version.outputs.version }}"
          echo "Branch: ${{ github.ref_name }}"
          cat ./deploy/build-info.json
          # Add actual deployment commands here
          echo "Deployment complete!"

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Pipeline Summary
    needs: [version, build, deploy-qa]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy QA | ${{ needs.deploy-qa.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.version.outputs.is-hotfix }}" == "true" ]; then
            echo "### ðŸ”¥ Hotfix Build" >> $GITHUB_STEP_SUMMARY
            echo "This is a hotfix build from \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Test in QA environment" >> $GITHUB_STEP_SUMMARY
            echo "2. Run **Release** workflow (type: hotfix) to create release" >> $GITHUB_STEP_SUMMARY
            echo "3. Deploy to Stage/Prod using **Deploy** workflow" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "- Artifact **calculator-${{ needs.version.outputs.version }}** is ready" >> $GITHUB_STEP_SUMMARY
            echo "- Run **Release** workflow for sprint release" >> $GITHUB_STEP_SUMMARY
          fi
