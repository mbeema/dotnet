# =============================================================================
# DEPLOY TO PRODUCTION
# =============================================================================
# Downloads artifact from GitHub Release and deploys to Production
# Requires environment approval
# =============================================================================

name: Deploy Prod

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to deploy (e.g., main-sprint-54 or hotfix-sprint-54-1)'
        required: true
        type: string
      change-ticket:
        description: 'Change ticket number (e.g., CHG0012345)'
        required: false
        type: string

permissions:
  contents: write
  actions: read

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Download artifact from GitHub Release
  # ---------------------------------------------------------------------------
  download:
    name: Download Artifact
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.download.outputs.version }}
      artifact-name: ${{ steps.download.outputs.artifact-name }}

    steps:
      - name: Validate tag exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if ! gh release view "${{ inputs.tag }}" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "::error::Release for tag '${{ inputs.tag }}' not found!"
            exit 1
          fi
          echo "âœ… Release found for tag: ${{ inputs.tag }}"

      - name: Download artifact from GitHub Release
        id: download
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ inputs.tag }}"

          echo "Downloading artifact from release: ${TAG}"
          gh release download "${TAG}" \
            --pattern "artifact.zip" \
            --repo ${{ github.repository }}

          # Extract
          unzip -o artifact.zip -d ./artifact-content

          # Get version from build-info.json
          VERSION=$(jq -r '.version' ./artifact-content/build-info.json)
          ARTIFACT_NAME="calculator-${VERSION}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "artifact-name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

          echo "âœ… Downloaded artifact version: ${VERSION}"
          cat ./artifact-content/build-info.json

      - name: Upload as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.download.outputs.artifact-name }}
          path: ./artifact-content
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Pre-deployment checklist
  # ---------------------------------------------------------------------------
  pre-deploy:
    name: Pre-deployment Check
    needs: download
    runs-on: ubuntu-latest

    steps:
      - name: Pre-deployment checklist
        run: |
          echo "## Pre-deployment Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | âœ… ${{ inputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | âœ… ${{ needs.download.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | âœ… Downloaded from release |" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ inputs.change-ticket }}" ]; then
            echo "| Change Ticket | âœ… ${{ inputs.change-ticket }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Change Ticket | âš ï¸ Not provided |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| Triggered by | âœ… ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Deploy to Production (requires environment approval)
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    needs: [download, pre-deploy]
    uses: ./.github/workflows/deploy.yml
    with:
      environment: prod
      artifact-name: ${{ needs.download.outputs.artifact-name }}
      version: ${{ needs.download.outputs.version }}
    secrets: inherit

  # ---------------------------------------------------------------------------
  # Post-deployment tasks
  # ---------------------------------------------------------------------------
  post-deploy:
    name: Post-deployment Tasks
    needs: [download, deploy]
    if: needs.deploy.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update production tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update prod tag to point to deployed release
          git tag -d prod 2>/dev/null || true
          git push origin :refs/tags/prod 2>/dev/null || true
          git tag -a prod -m "Production: ${{ needs.download.outputs.version }}" ${{ inputs.tag }}
          git push origin prod

          echo "âœ… Updated 'prod' tag to point to ${{ inputs.tag }}"

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Deployment Summary
    needs: [download, pre-deploy, deploy, post-deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.download.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Change Ticket:** ${{ inputs.change-ticket || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Download | ${{ needs.download.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-deploy | ${{ needs.pre-deploy.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Prod | ${{ needs.deploy.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Post-deploy | ${{ needs.post-deploy.result == 'success' && 'âœ… Success' || (needs.post-deploy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Production deployment successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Rollback:** Run this workflow with a previous tag" >> $GITHUB_STEP_SUMMARY
          fi

          # Cherry-pick reminder for hotfixes
          if [[ "${{ inputs.tag }}" == hotfix-* ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ Hotfix: Cherry-pick to main required" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "git checkout main && git pull" >> $GITHUB_STEP_SUMMARY
            echo "git cherry-pick <hotfix-commit-sha>" >> $GITHUB_STEP_SUMMARY
            echo "git push" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
