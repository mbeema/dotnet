# =============================================================================
# DEPLOY TO PRODUCTION
# =============================================================================
# Downloads artifact from GitHub Release and deploys to Production
# Requires environment approval
# =============================================================================

name: Deploy Prod

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to deploy (e.g., main-sprint-54 or hotfix-sprint-54-1)'
        required: true
        type: string
      change-ticket:
        description: 'Change ticket number (e.g., CHG0012345)'
        required: false
        type: string

permissions:
  contents: write
  actions: read

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: https://prod.example.com

    steps:
      - name: Validate tag exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if ! gh release view "${{ inputs.tag }}" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "::error::Release for tag '${{ inputs.tag }}' not found!"
            exit 1
          fi
          echo "âœ… Release found for tag: ${{ inputs.tag }}"

      - name: Download artifact from GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading artifact from release: ${{ inputs.tag }}"
          gh release download "${{ inputs.tag }}" \
            --pattern "artifact.zip" \
            --repo ${{ github.repository }}

          unzip -o artifact.zip -d ./deploy
          echo "âœ… Artifact downloaded and extracted"

      - name: Pre-deployment checklist
        run: |
          VERSION=$(jq -r '.version' ./deploy/build-info.json)
          echo "## Pre-deployment Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | âœ… ${{ inputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | âœ… ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | âœ… Downloaded from release |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.change-ticket }}" ]; then
            echo "| Change Ticket | âœ… ${{ inputs.change-ticket }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Change Ticket | âš ï¸ Not provided |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Triggered by | âœ… ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

      - name: Deploy to Production
        run: |
          echo "=========================================="
          echo "  DEPLOYING TO PRODUCTION"
          echo "=========================================="
          VERSION=$(jq -r '.version' ./deploy/build-info.json)
          echo "Tag     : ${{ inputs.tag }}"
          echo "Version : ${VERSION}"
          echo "Ticket  : ${{ inputs.change-ticket || 'N/A' }}"
          echo ""
          cat ./deploy/build-info.json
          echo ""
          # Add actual deployment commands here
          echo "Deployment complete!"

      - name: Checkout for tagging
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update production tag
        run: |
          VERSION=$(jq -r '.version' ./deploy/build-info.json)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update prod tag to point to deployed release
          git tag -d prod 2>/dev/null || true
          git push origin :refs/tags/prod 2>/dev/null || true
          git tag -a prod -m "Production: ${VERSION}" ${{ inputs.tag }}
          git push origin prod

          echo "âœ… Updated 'prod' tag to point to ${{ inputs.tag }}"

      - name: Generate summary
        run: |
          VERSION=$(jq -r '.version' ./deploy/build-info.json)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ inputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Change Ticket | ${{ inputs.change-ticket || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback:** Run this workflow with a previous tag" >> $GITHUB_STEP_SUMMARY

          # Cherry-pick reminder for hotfixes
          if [[ "${{ inputs.tag }}" == hotfix-* ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ Hotfix: Cherry-pick to main required" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "git checkout main && git pull" >> $GITHUB_STEP_SUMMARY
            echo "git cherry-pick <hotfix-commit-sha>" >> $GITHUB_STEP_SUMMARY
            echo "git push" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
