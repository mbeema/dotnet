# =============================================================================
# CREATE HOTFIX BRANCH
# =============================================================================
# Creates a hotfix branch from a release tag with consistent naming
# =============================================================================

name: Create Hotfix Branch

on:
  workflow_dispatch:
    inputs:
      base-tag:
        description: 'Release tag to branch from (e.g., main-sprint-54)'
        required: true
        type: string
      incident-id:
        description: 'Incident/ticket ID (e.g., INC001234)'
        required: true
        type: string
      description:
        description: 'Short description (lowercase, use-dashes)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  create-branch:
    name: Create Hotfix Branch
    runs-on: ubuntu-latest

    steps:
      - name: Validate inputs
        run: |
          # Validate base tag format
          if [[ ! "${{ inputs.base-tag }}" =~ ^(main-sprint-[0-9]+|hotfix-sprint-[0-9]+-[0-9]+)$ ]]; then
            echo "::error::Invalid tag format. Expected: main-sprint-N or hotfix-sprint-N-M"
            exit 1
          fi

          # Validate incident ID (alphanumeric)
          if [[ ! "${{ inputs.incident-id }}" =~ ^[A-Za-z0-9]+$ ]]; then
            echo "::error::Invalid incident ID. Use alphanumeric characters only."
            exit 1
          fi

          # Validate description (lowercase, dashes, no spaces)
          if [[ ! "${{ inputs.description }}" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
            echo "::error::Invalid description. Use lowercase letters, numbers, and dashes only."
            exit 1
          fi

          echo "✅ Input validation passed"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag exists
        run: |
          if ! git rev-parse "${{ inputs.base-tag }}" >/dev/null 2>&1; then
            echo "::error::Tag '${{ inputs.base-tag }}' does not exist!"
            echo ""
            echo "Available release tags:"
            git tag -l "main-sprint-*" | tail -5
            git tag -l "hotfix-sprint-*" | tail -5
            exit 1
          fi
          echo "✅ Tag '${{ inputs.base-tag }}' found"

      - name: Create hotfix branch
        id: create-branch
        run: |
          INCIDENT="${{ inputs.incident-id }}"
          DESCRIPTION="${{ inputs.description }}"
          BASE_TAG="${{ inputs.base-tag }}"

          # Normalize incident ID to uppercase
          INCIDENT_UPPER=$(echo "$INCIDENT" | tr '[:lower:]' '[:upper:]')

          # Create branch name
          BRANCH_NAME="hotfix/${INCIDENT_UPPER}-${DESCRIPTION}"

          # Check if branch already exists
          if git ls-remote --exit-code --heads origin "${BRANCH_NAME}" >/dev/null 2>&1; then
            echo "::error::Branch '${BRANCH_NAME}' already exists!"
            exit 1
          fi

          # Create and push branch from tag
          git checkout -b "${BRANCH_NAME}" "${BASE_TAG}"
          git push -u origin "${BRANCH_NAME}"

          echo "branch-name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "✅ Created branch: ${BRANCH_NAME}"

      - name: Generate summary
        run: |
          echo "## ✅ Hotfix Branch Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ steps.create-branch.outputs.branch-name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Base Tag | \`${{ inputs.base-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Incident | ${{ inputs.incident-id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Created By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Clone and checkout:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   git fetch origin" >> $GITHUB_STEP_SUMMARY
          echo "   git checkout ${{ steps.create-branch.outputs.branch-name }}" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Make fixes and push:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   # Make your changes" >> $GITHUB_STEP_SUMMARY
          echo "   git add . && git commit -m \"fix: description\"" >> $GITHUB_STEP_SUMMARY
          echo "   git push" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Run Release workflow:**" >> $GITHUB_STEP_SUMMARY
          echo "   - Type: \`hotfix\`" >> $GITHUB_STEP_SUMMARY
          echo "   - Base tag: \`${{ inputs.base-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "   - Hotfix branch: \`${{ steps.create-branch.outputs.branch-name }}\`" >> $GITHUB_STEP_SUMMARY
