# =============================================================================
# HOTFIX WORKFLOW
# =============================================================================
# Triggered on: Manual (critical production fixes)
# Pipeline: Build from main â†’ QA â†’ STAGE â†’ PROD (expedited)
# Creates hotfix tag (e.g., hotfix-1.0.1) for traceability
# Bypasses normal sprint cycle for critical fixes
# =============================================================================

name: Hotfix

on:
  workflow_dispatch:
    inputs:
      hotfix-description:
        description: 'Brief description of the hotfix'
        required: true
        type: string
      severity:
        description: 'Severity level'
        required: true
        type: choice
        options:
          - 'Critical - Production down'
          - 'High - Major functionality impacted'
          - 'Medium - Workaround available'
      incident-ticket:
        description: 'Incident ticket number (e.g., INC0012345)'
        required: true
        type: string
      skip-stage:
        description: 'Skip STAGE deployment (Critical only)'
        required: false
        type: boolean
        default: false
      base-tag:
        description: 'Base tag to hotfix from (defaults to current prod tag)'
        required: false
        type: string

concurrency:
  group: hotfix
  cancel-in-progress: false

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  # ---------------------------------------------------------------------------
  # Prepare hotfix
  # ---------------------------------------------------------------------------
  prepare:
    name: Prepare Hotfix
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag-name: ${{ steps.version.outputs.tag-name }}
      base-ref: ${{ steps.version.outputs.base-ref }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine hotfix version
        id: version
        run: |
          # Determine base reference
          if [ -n "${{ inputs.base-tag }}" ]; then
            BASE_REF="${{ inputs.base-tag }}"
          else
            # Use current prod tag or main
            BASE_REF=$(git describe --tags --match "prod" --abbrev=0 2>/dev/null || echo "main")
          fi

          # Get last hotfix number for today
          TODAY=$(date +%Y%m%d)
          LAST_HOTFIX=$(git tag -l "hotfix-${TODAY}.*" | sort -V | tail -1)

          if [ -n "$LAST_HOTFIX" ]; then
            # Increment hotfix number
            HOTFIX_NUM=$(echo "$LAST_HOTFIX" | grep -oE '[0-9]+$')
            HOTFIX_NUM=$((HOTFIX_NUM + 1))
          else
            HOTFIX_NUM=1
          fi

          VERSION="1.0.0-hotfix.${TODAY}.${HOTFIX_NUM}"
          TAG_NAME="hotfix-${TODAY}.${HOTFIX_NUM}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag-name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "base-ref=${BASE_REF}" >> $GITHUB_OUTPUT

          echo "## ðŸš¨ Hotfix Preparation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Description | ${{ inputs.hotfix-description }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | ${{ inputs.severity }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Incident | ${{ inputs.incident-ticket }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | ${TAG_NAME} |" >> $GITHUB_STEP_SUMMARY
          echo "| Base | ${BASE_REF} |" >> $GITHUB_STEP_SUMMARY

      - name: Validate severity for skip-stage
        if: ${{ inputs.skip-stage && inputs.severity != 'Critical - Production down' }}
        run: |
          echo "::error::Skip STAGE is only allowed for Critical severity hotfixes!"
          exit 1

  # ---------------------------------------------------------------------------
  # Build hotfix
  # ---------------------------------------------------------------------------
  build:
    name: Build Hotfix
    needs: prepare
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
      is-release: true

  # ---------------------------------------------------------------------------
  # Create hotfix tag
  # ---------------------------------------------------------------------------
  create-tag:
    name: Create Hotfix Tag
    needs: [prepare, build]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG_MESSAGE="ðŸš¨ HOTFIX: ${{ inputs.hotfix-description }}

          Version: ${{ needs.prepare.outputs.version }}
          Severity: ${{ inputs.severity }}
          Incident: ${{ inputs.incident-ticket }}
          Date: $(date -u +%Y-%m-%d)
          Commit: ${{ github.sha }}
          Triggered by: ${{ github.actor }}"

          git tag -a "${{ needs.prepare.outputs.tag-name }}" -m "${TAG_MESSAGE}"
          git push origin "${{ needs.prepare.outputs.tag-name }}"

          echo "âœ… Created tag: ${{ needs.prepare.outputs.tag-name }}"

  # ---------------------------------------------------------------------------
  # Deploy to QA (quick validation)
  # ---------------------------------------------------------------------------
  deploy-qa:
    name: Deploy to QA
    needs: [prepare, build, create-tag]
    uses: ./.github/workflows/deploy.yml
    with:
      environment: qa
      artifact-name: ${{ needs.build.outputs.artifact-name }}
      version: ${{ needs.prepare.outputs.version }}
    secrets: inherit

  # ---------------------------------------------------------------------------
  # QA validation gate
  # ---------------------------------------------------------------------------
  qa-validation:
    name: QA Validation
    needs: [prepare, deploy-qa]
    runs-on: ubuntu-latest
    environment:
      name: qa-validation
      # This creates a manual approval gate after QA deployment

    steps:
      - name: QA validation checkpoint
        run: |
          echo "## QA Validation Checkpoint" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Hotfix deployed to QA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Please verify the following before approving:**" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Hotfix resolves the reported issue" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No regression in existing functionality" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Smoke tests pass" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Deploy to STAGE (unless skipped for critical)
  # ---------------------------------------------------------------------------
  deploy-stage:
    name: Deploy to Stage
    needs: [prepare, build, qa-validation]
    if: ${{ !inputs.skip-stage }}
    uses: ./.github/workflows/deploy.yml
    with:
      environment: stage
      artifact-name: ${{ needs.build.outputs.artifact-name }}
      version: ${{ needs.prepare.outputs.version }}
    secrets: inherit

  # ---------------------------------------------------------------------------
  # Deploy to PROD
  # ---------------------------------------------------------------------------
  deploy-prod:
    name: Deploy to Production
    needs: [prepare, build, qa-validation, deploy-stage]
    if: ${{ always() && needs.qa-validation.result == 'success' && (needs.deploy-stage.result == 'success' || needs.deploy-stage.result == 'skipped') }}
    uses: ./.github/workflows/deploy.yml
    with:
      environment: prod
      artifact-name: ${{ needs.build.outputs.artifact-name }}
      version: ${{ needs.prepare.outputs.version }}
    secrets: inherit

  # ---------------------------------------------------------------------------
  # Post-hotfix tasks
  # ---------------------------------------------------------------------------
  post-hotfix:
    name: Post-Hotfix Tasks
    needs: [prepare, deploy-prod]
    runs-on: ubuntu-latest

    steps:
      - name: Update prod tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update production tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update prod tag
          git tag -d prod 2>/dev/null || true
          git push origin :refs/tags/prod 2>/dev/null || true
          git tag -a prod -m "Production: ${{ needs.prepare.outputs.version }} (Hotfix)" ${{ needs.prepare.outputs.tag-name }}
          git push origin prod

      - name: Create incident resolution note
        run: |
          echo "## ðŸš¨ Hotfix Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Incident:** ${{ inputs.incident-ticket }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resolution:** Hotfix ${{ needs.prepare.outputs.version }} deployed to production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Action Items" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Update incident ticket with resolution details" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Notify stakeholders of resolution" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Schedule post-mortem if needed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Consider if fix needs backport to feature branches" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Hotfix Summary
    needs: [prepare, build, create-tag, deploy-qa, qa-validation, deploy-stage, deploy-prod, post-hotfix]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš¨ Hotfix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Description:** ${{ inputs.hotfix-description }}" >> $GITHUB_STEP_SUMMARY
          echo "**Severity:** ${{ inputs.severity }}" >> $GITHUB_STEP_SUMMARY
          echo "**Incident:** ${{ inputs.incident-ticket }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.prepare.outputs.tag-name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create Tag | ${{ needs.create-tag.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy QA | ${{ needs.deploy-qa.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| QA Validation | ${{ needs.qa-validation.result == 'success' && 'âœ… Approved' || 'âŒ Failed/Rejected' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Stage | ${{ needs.deploy-stage.result == 'success' && 'âœ… Success' || (needs.deploy-stage.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Prod | ${{ needs.deploy-prod.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-prod.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Hotfix deployed successfully!" >> $GITHUB_STEP_SUMMARY
            DURATION=$(($(date +%s) - ${{ github.event.repository.pushed_at }}))
            echo "Total pipeline time: ~${DURATION}s" >> $GITHUB_STEP_SUMMARY
          fi
