# =============================================================================
# HOTFIX WORKFLOW
# =============================================================================
# Triggered on: Manual (critical production fixes)
# Pipeline: Build from main â†’ QA â†’ STAGE â†’ PROD (expedited)
# Creates hotfix tag (e.g., hotfix-1.0.1) for traceability
# Bypasses normal sprint cycle for critical fixes
# =============================================================================

name: Hotfix

on:
  workflow_dispatch:
    inputs:
      hotfix-description:
        description: 'Brief description of the hotfix'
        required: true
        type: string
      severity:
        description: 'Severity level'
        required: true
        type: choice
        options:
          - 'Critical - Production down'
          - 'High - Major functionality impacted'
          - 'Medium - Workaround available'
      incident-ticket:
        description: 'Incident ticket number (e.g., INC0012345)'
        required: true
        type: string
      skip-stage:
        description: 'Skip STAGE deployment (Critical only)'
        required: false
        type: boolean
        default: false
      base-tag:
        description: 'Base tag to hotfix from (e.g., sprint-54)'
        required: true
        type: string
      hotfix-branch:
        description: 'Hotfix branch name (e.g., hotfix/fix-login-bug)'
        required: true
        type: string

permissions:
  contents: write
  actions: read

concurrency:
  group: hotfix
  cancel-in-progress: false

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  # ---------------------------------------------------------------------------
  # Prepare hotfix
  # ---------------------------------------------------------------------------
  prepare:
    name: Prepare Hotfix
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag-name: ${{ steps.version.outputs.tag-name }}
      base-ref: ${{ steps.version.outputs.base-ref }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate inputs
        run: |
          # Verify base tag exists
          if ! git rev-parse "${{ inputs.base-tag }}" >/dev/null 2>&1; then
            echo "::error::Base tag '${{ inputs.base-tag }}' does not exist!"
            exit 1
          fi

          # Verify hotfix branch exists
          if ! git ls-remote --exit-code --heads origin "${{ inputs.hotfix-branch }}" >/dev/null 2>&1; then
            echo "::error::Hotfix branch '${{ inputs.hotfix-branch }}' does not exist!"
            echo "::error::Create it first: git checkout -b ${{ inputs.hotfix-branch }} ${{ inputs.base-tag }}"
            exit 1
          fi

          echo "âœ… Base tag and hotfix branch validated"

      - name: Determine hotfix version
        id: version
        run: |
          BASE_REF="${{ inputs.base-tag }}"

          # Get last hotfix number for today
          TODAY=$(date +%Y%m%d)
          LAST_HOTFIX=$(git tag -l "hotfix-${TODAY}.*" | sort -V | tail -1)

          if [ -n "$LAST_HOTFIX" ]; then
            # Increment hotfix number
            HOTFIX_NUM=$(echo "$LAST_HOTFIX" | grep -oE '[0-9]+$')
            HOTFIX_NUM=$((HOTFIX_NUM + 1))
          else
            HOTFIX_NUM=1
          fi

          VERSION="1.0.${TODAY}${HOTFIX_NUM}"
          TAG_NAME="hotfix-${TODAY}.${HOTFIX_NUM}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag-name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "base-ref=${BASE_REF}" >> $GITHUB_OUTPUT

          echo "## ðŸš¨ Hotfix Preparation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Description | ${{ inputs.hotfix-description }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | ${{ inputs.severity }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Incident | ${{ inputs.incident-ticket }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | ${TAG_NAME} |" >> $GITHUB_STEP_SUMMARY
          echo "| Base Tag | ${BASE_REF} |" >> $GITHUB_STEP_SUMMARY
          echo "| Hotfix Branch | ${{ inputs.hotfix-branch }} |" >> $GITHUB_STEP_SUMMARY

      - name: Validate severity for skip-stage
        if: ${{ inputs.skip-stage && inputs.severity != 'Critical - Production down' }}
        run: |
          echo "::error::Skip STAGE is only allowed for Critical severity hotfixes!"
          exit 1

  # ---------------------------------------------------------------------------
  # Build hotfix (from hotfix branch)
  # ---------------------------------------------------------------------------
  build:
    name: Build Hotfix
    needs: prepare
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
      is-release: true
      ref: ${{ inputs.hotfix-branch }}

  # ---------------------------------------------------------------------------
  # Create hotfix tag (on hotfix branch)
  # ---------------------------------------------------------------------------
  create-tag:
    name: Create Hotfix Tag
    needs: [prepare, build]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout hotfix branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.hotfix-branch }}
          fetch-depth: 0

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          COMMIT_SHA=$(git rev-parse HEAD)

          TAG_MESSAGE="ðŸš¨ HOTFIX: ${{ inputs.hotfix-description }}

          Version: ${{ needs.prepare.outputs.version }}
          Severity: ${{ inputs.severity }}
          Incident: ${{ inputs.incident-ticket }}
          Base Tag: ${{ inputs.base-tag }}
          Hotfix Branch: ${{ inputs.hotfix-branch }}
          Date: $(date -u +%Y-%m-%d)
          Commit: ${COMMIT_SHA}
          Triggered by: ${{ github.actor }}"

          git tag -a "${{ needs.prepare.outputs.tag-name }}" -m "${TAG_MESSAGE}"
          git push origin "${{ needs.prepare.outputs.tag-name }}"

          echo "âœ… Created tag: ${{ needs.prepare.outputs.tag-name }}"

  # ---------------------------------------------------------------------------
  # Deploy to QA (quick validation)
  # ---------------------------------------------------------------------------
  deploy-qa:
    name: Deploy to QA
    needs: [prepare, build, create-tag]
    uses: ./.github/workflows/deploy.yml
    with:
      environment: qa
      artifact-name: ${{ needs.build.outputs.artifact-name }}
      version: ${{ needs.prepare.outputs.version }}
    secrets: inherit

  # ---------------------------------------------------------------------------
  # QA validation gate
  # ---------------------------------------------------------------------------
  qa-validation:
    name: QA Validation
    needs: [prepare, deploy-qa]
    runs-on: ubuntu-latest
    environment:
      name: qa-validation
      # This creates a manual approval gate after QA deployment

    steps:
      - name: QA validation checkpoint
        run: |
          echo "## QA Validation Checkpoint" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Hotfix deployed to QA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Please verify the following before approving:**" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Hotfix resolves the reported issue" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No regression in existing functionality" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Smoke tests pass" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Deploy to STAGE (unless skipped for critical)
  # ---------------------------------------------------------------------------
  deploy-stage:
    name: Deploy to Stage
    needs: [prepare, build, qa-validation]
    if: ${{ !inputs.skip-stage }}
    uses: ./.github/workflows/deploy.yml
    with:
      environment: stage
      artifact-name: ${{ needs.build.outputs.artifact-name }}
      version: ${{ needs.prepare.outputs.version }}
    secrets: inherit

  # ---------------------------------------------------------------------------
  # Deploy to PROD
  # ---------------------------------------------------------------------------
  deploy-prod:
    name: Deploy to Production
    needs: [prepare, build, qa-validation, deploy-stage]
    if: ${{ always() && needs.qa-validation.result == 'success' && (needs.deploy-stage.result == 'success' || needs.deploy-stage.result == 'skipped') }}
    uses: ./.github/workflows/deploy.yml
    with:
      environment: prod
      artifact-name: ${{ needs.build.outputs.artifact-name }}
      version: ${{ needs.prepare.outputs.version }}
    secrets: inherit

  # ---------------------------------------------------------------------------
  # Create GitHub Release (for build-once traceability)
  # ---------------------------------------------------------------------------
  create-release:
    name: Create GitHub Release
    needs: [prepare, build, create-tag, deploy-prod]
    if: needs.deploy-prod.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.hotfix-branch }}
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./release-artifact

      - name: Zip artifact for release
        run: |
          cd release-artifact
          zip -r ../artifact.zip .

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.tag-name }}
          name: "ðŸš¨ Hotfix: ${{ inputs.hotfix-description }}"
          files: artifact.zip
          body: |
            ## ðŸš¨ Hotfix Release

            **Version:** ${{ needs.prepare.outputs.version }}
            **Incident:** ${{ inputs.incident-ticket }}
            **Severity:** ${{ inputs.severity }}
            **Base Tag:** ${{ inputs.base-tag }}

            ### Description
            ${{ inputs.hotfix-description }}

            ### Deployment Status
            - âœ… QA: Deployed
            - âœ… Stage: ${{ inputs.skip-stage && 'Skipped' || 'Deployed' }}
            - âœ… Production: Deployed

            ### Post-Hotfix Checklist
            - [ ] Cherry-pick fix to main branch
            - [ ] Update incident ticket
            - [ ] Notify stakeholders
            - [ ] Schedule post-mortem if needed

  # ---------------------------------------------------------------------------
  # Post-hotfix tasks
  # ---------------------------------------------------------------------------
  post-hotfix:
    name: Post-Hotfix Tasks
    needs: [prepare, build, deploy-prod, create-release]
    if: always() && needs.deploy-prod.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.hotfix-branch }}
          fetch-depth: 0

      - name: Update production tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update prod tag to point to hotfix
          git tag -d prod 2>/dev/null || true
          git push origin :refs/tags/prod 2>/dev/null || true
          git tag -a prod -m "Production: ${{ needs.prepare.outputs.version }} (Hotfix)" ${{ needs.prepare.outputs.tag-name }}
          git push origin prod

      - name: Get hotfix commit SHA
        id: commit
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT

      - name: Post-hotfix summary
        run: |
          echo "## ðŸš¨ Hotfix Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Incident:** ${{ inputs.incident-ticket }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.prepare.outputs.tag-name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Required: Cherry-pick to main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git checkout main" >> $GITHUB_STEP_SUMMARY
          echo "git pull" >> $GITHUB_STEP_SUMMARY
          echo "git cherry-pick ${{ steps.commit.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "git push" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Action Items" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] **Cherry-pick fix to main** (required)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Update incident ticket with resolution" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Notify stakeholders" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Schedule post-mortem if needed" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Hotfix Summary
    needs: [prepare, build, create-tag, deploy-qa, qa-validation, deploy-stage, deploy-prod, create-release, post-hotfix]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš¨ Hotfix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Description:** ${{ inputs.hotfix-description }}" >> $GITHUB_STEP_SUMMARY
          echo "**Severity:** ${{ inputs.severity }}" >> $GITHUB_STEP_SUMMARY
          echo "**Incident:** ${{ inputs.incident-ticket }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.prepare.outputs.tag-name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create Tag | ${{ needs.create-tag.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy QA | ${{ needs.deploy-qa.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| QA Validation | ${{ needs.qa-validation.result == 'success' && 'âœ… Approved' || 'âŒ Failed/Rejected' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Stage | ${{ needs.deploy-stage.result == 'success' && 'âœ… Success' || (needs.deploy-stage.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Prod | ${{ needs.deploy-prod.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-prod.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Hotfix deployed successfully!" >> $GITHUB_STEP_SUMMARY
            DURATION=$(($(date +%s) - ${{ github.event.repository.pushed_at }}))
            echo "Total pipeline time: ~${DURATION}s" >> $GITHUB_STEP_SUMMARY
          fi
