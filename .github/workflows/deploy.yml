# =============================================================================
# DEPLOY WORKFLOW
# =============================================================================
# Deploy any release to any environment (QA, Stage, Prod)
# Downloads artifact from GitHub Release and deploys
# =============================================================================

name: Deploy

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.54.0) or "latest" for most recent'
        required: true
        type: string
        default: 'latest'
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - 'qa'
          - 'stage'
          - 'prod'
      change-ticket:
        description: 'Change ticket (required for prod)'
        required: false
        type: string

permissions:
  contents: write
  actions: read

concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Validate
  # ---------------------------------------------------------------------------
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.validate.outputs.tag }}

    steps:
      - name: Resolve and validate tag
        id: validate
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          INPUT_TAG="${{ inputs.tag }}"

          # Resolve "latest" to actual tag
          if [ "$INPUT_TAG" == "latest" ]; then
            TAG=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName --jq '.[0].tagName')
            if [ -z "$TAG" ]; then
              echo "::error::No releases found!"
              exit 1
            fi
            echo "Resolved 'latest' to: ${TAG}"
          else
            TAG="$INPUT_TAG"
          fi

          # Validate tag exists
          if ! gh release view "${TAG}" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "::error::Release for tag '${TAG}' not found!"
            echo ""
            echo "Available releases:"
            gh release list --repo ${{ github.repository }} --limit 10
            exit 1
          fi

          # Require change ticket for prod
          if [ "${{ inputs.environment }}" == "prod" ] && [ -z "${{ inputs.change-ticket }}" ]; then
            echo "::warning::No change ticket provided for production deployment"
          fi

          echo "âœ… Release found: ${TAG}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # Deploy
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to ${{ inputs.environment }}
    needs: validate
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ inputs.environment }}.example.com

    steps:
      - name: Download artifact from GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          echo "Downloading artifact from release: ${TAG}"
          gh release download "${TAG}" \
            --pattern "artifact.zip" \
            --repo ${{ github.repository }}

          unzip -o artifact.zip -d ./deploy
          echo "âœ… Artifact downloaded and extracted"

      - name: Pre-deployment info
        run: |
          VERSION=$(jq -r '.version' ./deploy/build-info.json)
          echo "## Pre-deployment Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ needs.validate.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.change-ticket }}" ]; then
            echo "| Change Ticket | ${{ inputs.change-ticket }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Deploy to ${{ inputs.environment }}
        run: |
          echo "=========================================="
          echo "  DEPLOYING TO ${{ inputs.environment }}"
          echo "=========================================="
          VERSION=$(jq -r '.version' ./deploy/build-info.json)
          echo "Tag         : ${{ needs.validate.outputs.tag }}"
          echo "Version     : ${VERSION}"
          echo "Environment : ${{ inputs.environment }}"
          echo "Ticket      : ${{ inputs.change-ticket || 'N/A' }}"
          echo ""
          cat ./deploy/build-info.json
          echo ""
          # Add actual deployment commands here
          echo "Deployment complete!"

      - name: Smoke test
        run: |
          echo "Running smoke tests for ${{ inputs.environment }}..."
          # Add actual smoke tests here
          # Example: curl -f https://${{ inputs.environment }}.example.com/health
          echo "Smoke tests passed!"

  # ---------------------------------------------------------------------------
  # Post-deployment (prod only)
  # ---------------------------------------------------------------------------
  post-deploy:
    name: Post-deployment
    needs: [validate, deploy]
    if: inputs.environment == 'prod'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout for tagging
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update production tag
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update prod tag to point to deployed release
          git tag -d prod 2>/dev/null || true
          git push origin :refs/tags/prod 2>/dev/null || true
          git tag -a prod -m "Production: ${TAG}" "${TAG}"
          git push origin prod

          echo "âœ… Updated 'prod' tag to point to ${TAG}"

  # ---------------------------------------------------------------------------
  # Update GitHub Release with deployment status
  # ---------------------------------------------------------------------------
  update-release:
    name: Update Release Status
    needs: [validate, deploy]
    if: needs.deploy.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Update GitHub Release body
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          ENV="${{ inputs.environment }}"
          ACTOR="${{ github.actor }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")

          # Get current release body
          CURRENT_BODY=$(gh release view "${TAG}" --repo ${{ github.repository }} --json body --jq '.body')

          # Create deployment status line
          DEPLOY_LINE="| ${ENV} | âœ… ${ACTOR} @ ${TIMESTAMP} |"

          # Check if deployment status table exists
          if echo "$CURRENT_BODY" | grep -q "### Deployment Status"; then
            # Check if this environment is already in the table
            if echo "$CURRENT_BODY" | grep -q "| ${ENV} |"; then
              # Replace existing line for this environment
              NEW_BODY=$(echo "$CURRENT_BODY" | awk -v env="${ENV}" -v line="${DEPLOY_LINE}" '
                /\| '"${ENV}"' \|/ { print line; next }
                { print }
              ')
            else
              # Add new row to existing table (after the header row)
              NEW_BODY=$(echo "$CURRENT_BODY" | awk -v line="${DEPLOY_LINE}" '
                /\|----------/ { print; print line; next }
                { print }
              ')
            fi
          else
            # Add new deployment status section at the end
            NEW_BODY="${CURRENT_BODY}

### Deployment Status
| Environment | Status |
|-------------|--------|
${DEPLOY_LINE}"
          fi

          # Update the release
          echo "$NEW_BODY" > /tmp/release-body.md
          gh release edit "${TAG}" --repo ${{ github.repository }} --notes-file /tmp/release-body.md

          echo "âœ… Updated release ${TAG} with ${ENV} deployment status"

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Deployment Summary
    needs: [validate, deploy, update-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download artifact for version
        if: needs.deploy.result == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          gh release download "${TAG}" \
            --pattern "artifact.zip" \
            --repo ${{ github.repository }}
          unzip -o artifact.zip -d ./deploy

      - name: Generate summary
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          if [ -f "./deploy/build-info.json" ]; then
            VERSION=$(jq -r '.version' ./deploy/build-info.json)
          else
            VERSION="${TAG}"
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.deploy.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.environment }}" == "prod" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Rollback:** Run this workflow with a previous tag" >> $GITHUB_STEP_SUMMARY

            # Cherry-pick reminder for hotfixes (patch version > 0)
            PATCH_VERSION=$(echo "${TAG}" | sed 's/v[0-9]*\.[0-9]*\.//')
            if [[ "$PATCH_VERSION" != "0" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âš ï¸ Hotfix: Cherry-pick to main required" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              echo "git checkout main && git pull" >> $GITHUB_STEP_SUMMARY
              echo "git cherry-pick <hotfix-commit-sha>" >> $GITHUB_STEP_SUMMARY
              echo "git push" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi
