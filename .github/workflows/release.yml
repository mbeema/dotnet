# =============================================================================
# RELEASE WORKFLOW - Create versioned releases
# =============================================================================
# Triggers:
#   - Manual: Create sprint or hotfix release
#   - Schedule: Auto-create sprint release (bi-weekly Tuesday 6 PM UTC)
#
# Version is AUTO-CALCULATED:
#   - Sprint: Last sprint + 1 (e.g., v1.54.0 → v1.55.0)
#   - Hotfix: Last patch + 1 (e.g., v1.54.0 → v1.54.1)
# =============================================================================

name: Release

on:
  workflow_dispatch:
    inputs:
      type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - sprint
          - hotfix
      sprint-number:
        description: 'Sprint: number (optional, auto-increments from last tag if not provided)'
        required: false
        type: string
      hotfix-branch:
        description: 'Hotfix: branch name (REQUIRED, e.g., hotfix/INC123-fix-login)'
        required: false
        type: string
      notes:
        description: 'Release notes (optional)'
        required: false
        type: string

  schedule:
    - cron: '0 18 * * 2'  # Tuesday 6 PM UTC (bi-weekly)

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  # ===========================================================================
  # PREPARE - Auto-calculate version
  # ===========================================================================
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.config.outputs.skip }}
      version: ${{ steps.config.outputs.version }}
      tag: ${{ steps.config.outputs.tag }}
      source: ${{ steps.config.outputs.source }}
      type: ${{ steps.config.outputs.type }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version
        id: config
        run: |
          # Fetch all tags
          git fetch --tags

          # Determine release type
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            WEEK=$(date +%V)
            if [[ $((WEEK % 2)) -ne 0 ]]; then
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "Skipping: not a sprint week (week ${WEEK})"
              exit 0
            fi
            TYPE="sprint"
          else
            TYPE="${{ inputs.type }}"
          fi

          echo "Release type: ${TYPE}"

          # =====================================================
          # SPRINT RELEASE
          # =====================================================
          if [[ "$TYPE" == "sprint" ]]; then
            SOURCE="main"
            INPUT_SPRINT="${{ inputs.sprint-number }}"

            if [[ -n "$INPUT_SPRINT" ]]; then
              # Sprint number provided - use it
              SPRINT_NUM="${INPUT_SPRINT}"
              VERSION="1.${SPRINT_NUM}.0"
              echo "Sprint number provided: ${SPRINT_NUM} → v${VERSION}"
            else
              # Auto-detect from last tag
              LAST_SPRINT_TAG=$(git tag -l "v*.*.*" | grep -E "^v[0-9]+\.[0-9]+\.0$" | sort -V | tail -1)

              if [[ -z "$LAST_SPRINT_TAG" ]]; then
                VERSION="1.1.0"
                SPRINT_NUM="1"
                echo "No previous sprint found, starting at v${VERSION}"
              else
                LAST_VERSION="${LAST_SPRINT_TAG#v}"
                MAJOR=$(echo "$LAST_VERSION" | cut -d. -f1)
                MINOR=$(echo "$LAST_VERSION" | cut -d. -f2)
                NEW_MINOR=$((MINOR + 1))
                VERSION="${MAJOR}.${NEW_MINOR}.0"
                SPRINT_NUM="${NEW_MINOR}"
                echo "Last sprint: ${LAST_SPRINT_TAG} → New: v${VERSION}"
              fi
            fi

          # =====================================================
          # HOTFIX RELEASE
          # =====================================================
          else
            SOURCE="${{ inputs.hotfix-branch }}"

            # Validate hotfix branch is provided
            if [[ -z "$SOURCE" ]]; then
              echo "::error::Hotfix branch is required!"
              echo ""
              echo "Please provide the hotfix branch name, e.g.:"
              echo "  hotfix/INC123-fix-login"
              echo ""
              echo "Available hotfix branches:"
              git ls-remote --heads origin 'hotfix/*' | sed 's/.*refs\/heads\//  /' || echo "  (none found)"
              exit 1
            fi

            # Validate branch exists
            if ! git ls-remote --exit-code --heads origin "${SOURCE}" >/dev/null 2>&1; then
              echo "::error::Hotfix branch '${SOURCE}' not found!"
              echo ""
              echo "Available hotfix branches:"
              git ls-remote --heads origin 'hotfix/*' | sed 's/.*refs\/heads\//  /' || echo "  (none found)"
              exit 1
            fi

            # Find base tag from branch
            git fetch origin "${SOURCE}" --depth=100 2>/dev/null || true
            MERGE_BASE=$(git merge-base origin/main "origin/${SOURCE}" 2>/dev/null || echo "")

            if [[ -n "$MERGE_BASE" ]]; then
              BASE_TAG=$(git describe --tags --abbrev=0 "$MERGE_BASE" 2>/dev/null || echo "")
            fi

            if [[ -z "$BASE_TAG" ]]; then
              # Fallback: use latest sprint tag
              BASE_TAG=$(git tag -l "v*.*.*" | grep -E "^v[0-9]+\.[0-9]+\.0$" | sort -V | tail -1)
            fi

            if [[ -z "$BASE_TAG" ]]; then
              echo "::error::Cannot determine base sprint version for hotfix"
              exit 1
            fi

            # Extract sprint number from base tag
            BASE_VERSION="${BASE_TAG#v}"
            MAJOR=$(echo "$BASE_VERSION" | cut -d. -f1)
            MINOR=$(echo "$BASE_VERSION" | cut -d. -f2)
            SPRINT_NUM="${MINOR}"

            # Find latest patch and increment
            LAST_PATCH_TAG=$(git tag -l "v${MAJOR}.${MINOR}.*" | sort -V | tail -1)
            LAST_PATCH=$(echo "${LAST_PATCH_TAG#v}" | cut -d. -f3)
            NEW_PATCH=$((LAST_PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

            echo "Hotfix for Sprint: ${SPRINT_NUM}"
            echo "Base tag: ${BASE_TAG} → New: v${VERSION}"
          fi

          TAG="v${VERSION}"

          # Validate tag doesn't exist
          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "::error::Tag ${TAG} already exists!"
            exit 1
          fi

          echo "skip=false" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "source=${SOURCE}" >> $GITHUB_OUTPUT
          echo "type=${TYPE}" >> $GITHUB_OUTPUT

          # Summary
          echo "## Release Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Type | ${TYPE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sprint | **${SPRINT_NUM}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | **${VERSION}** (auto-calculated) |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | ${TAG} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source | ${SOURCE} |" >> $GITHUB_STEP_SUMMARY
          if [[ "$TYPE" == "hotfix" ]]; then
            echo "| Base | ${BASE_TAG} |" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # BUILD
  # ===========================================================================
  build:
    name: Build
    needs: prepare
    if: needs.prepare.outputs.skip != 'true'
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.build.outputs.artifact-name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.source }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build & Test
        id: build
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          ARTIFACT="app-${VERSION}"

          dotnet restore
          dotnet build -c Release -p:Version=${VERSION}
          dotnet test -c Release --no-build
          dotnet publish src/Calculator/Calculator.csproj -c Release --no-build -o ./publish

          # Build info
          cat > ./publish/build-info.json << EOF
          {
            "version": "${VERSION}",
            "tag": "${{ needs.prepare.outputs.tag }}",
            "type": "${{ needs.prepare.outputs.type }}",
            "commit": "${{ github.sha }}",
            "source": "${{ needs.prepare.outputs.source }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "artifact-name=${ARTIFACT}" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact-name }}
          path: ./publish

  # ===========================================================================
  # CREATE RELEASE
  # ===========================================================================
  release:
    name: Create Release
    needs: [prepare, build]
    if: needs.prepare.outputs.skip != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.source }}
          fetch-depth: 0

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./release

      - name: Create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.prepare.outputs.tag }}" -m "${{ needs.prepare.outputs.type }} release ${{ needs.prepare.outputs.version }}"
          git push origin "${{ needs.prepare.outputs.tag }}"

      - name: Zip artifact
        run: |
          cd release && zip -r ../artifact.zip .

      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -n "$LAST_TAG" ]]; then
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | head -20)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -10)
          fi
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: "${{ needs.prepare.outputs.type == 'sprint' && 'Sprint' || 'Hotfix' }} ${{ needs.prepare.outputs.version }}"
          files: artifact.zip
          body: |
            ## ${{ needs.prepare.outputs.type == 'sprint' && 'Sprint Release' || 'Hotfix Release' }}

            **Version:** ${{ needs.prepare.outputs.version }}
            **Source:** ${{ needs.prepare.outputs.source }}

            ### Notes
            ${{ inputs.notes || 'No release notes provided.' }}

            ### Changes
            ${{ steps.changelog.outputs.commits }}

            ---
            **Deploy:** Run `Deploy` workflow with tag `${{ needs.prepare.outputs.tag }}`

  # ===========================================================================
  # AUTO-DEPLOY TO STAGE
  # ===========================================================================
  deploy-stage:
    name: Deploy to Stage
    needs: [prepare, build, release]
    if: needs.prepare.outputs.skip != 'true'
    runs-on: ubuntu-latest
    environment:
      name: stage
      url: https://stage.example.com

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./deploy

      - name: Deploy to Stage
        run: |
          echo "============================================"
          echo "  AUTO-DEPLOYING TO STAGE"
          echo "============================================"
          echo ""
          echo "Tag:     ${{ needs.prepare.outputs.tag }}"
          echo "Version: ${{ needs.prepare.outputs.version }}"
          echo "Type:    ${{ needs.prepare.outputs.type }}"
          echo ""
          cat ./deploy/build-info.json
          echo ""
          echo "--------------------------------------------"
          echo "Running deployment script..."
          echo "--------------------------------------------"
          # =============================================
          # DUMMY DEPLOYMENT - Replace with actual deploy
          # Example for Azure App Service:
          # az webapp deploy --resource-group $RG --name $APP_STAGE --src-path ./deploy
          # =============================================
          sleep 2
          echo "Stage deployment successful!"

      - name: Smoke test
        run: |
          echo "Running smoke tests for stage..."
          # Add actual smoke tests
          # Example: curl -f https://stage.example.com/health
          sleep 1
          echo "Smoke tests passed!"

  # ===========================================================================
  # SUMMARY
  # ===========================================================================
  summary:
    name: Summary
    needs: [prepare, build, release, deploy-stage]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        run: |
          if [[ "${{ needs.prepare.outputs.skip }}" == "true" ]]; then
            echo "## Release Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Not a sprint week." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Release Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Tag | ${{ needs.prepare.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Version | ${{ needs.prepare.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Type | ${{ needs.prepare.outputs.type }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Stage Deploy | ${{ needs.deploy-stage.result == 'success' && 'Success' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next:** Test on Stage, then run Deploy workflow for Prod" >> $GITHUB_STEP_SUMMARY
          fi
